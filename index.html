<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Scissor Mechanism (minimal + free draw + anchor + laser SVG)" />
    <title>Scissor Mechanism · Anchor & Laser Export</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- 修复 p5.js 加载，使用更稳定的CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script>
      // 改进的 p5.js 加载检测
      window.addEventListener('DOMContentLoaded', () => {
        let retryCount = 0;
        const maxRetries = 3;
        
        function checkP5() {
          if (window.p5) {
            console.log('p5.js loaded successfully');
            return;
          }
          
          if (retryCount < maxRetries) {
            retryCount++;
            console.log(`Attempting to load p5.js backup (attempt ${retryCount})`);
            const script = document.createElement('script');
            script.src = `https://cdn.jsdelivr.net/npm/p5@1.7.0/lib/p5.min.js`;
            script.onerror = () => {
              console.error(`Failed to load p5.js (attempt ${retryCount})`);
              if (retryCount >= maxRetries) {
                alert('Failed to load p5.js library. Please refresh the page.');
              }
            };
            document.head.appendChild(script);
          }
        }
        
        setTimeout(checkP5, 1000);
      });
    </script>
  </head>
  <body>
    <!-- Left control panel -->
    <div class="gui-panel">
      <h1 class="gui-title">Scissor Mechanism</h1>

      <section class="section">
        <div class="section-title">Curve</div>
        <div class="curve-selector">
          <button class="curve-btn active" data-curve="arc">Arc</button>
          <button class="curve-btn" data-curve="sine">Sine</button>
          <button class="curve-btn" data-curve="free">Free draw</button>
        </div>
      </section>

      <section class="section">
        <div class="section-title">Basic</div>
        <label class="slider-group">
          <div class="slider-label">
            <span>Segments</span><span id="segmentValue" class="value">4</span>
          </div>
          <input type="range" id="segmentSlider" min="2" max="12" value="4" />
        </label>

        <label class="slider-group">
          <div class="slider-label">
            <span>Link length (px)</span><span id="linkLengthValue" class="value">60</span>
          </div>
          <input type="range" id="linkLengthSlider" min="30" max="120" value="60" />
        </label>
      </section>

      <section class="section">
        <div class="section-title">Curve Params</div>
        <label class="slider-group">
          <div class="slider-label">
            <span>Curvature</span><span id="curvatureValue" class="value">1.0</span>
          </div>
          <input type="range" id="curvatureSlider" min="0.1" max="3.0" value="1.0" step="0.1" />
        </label>

        <label class="slider-group">
          <div class="slider-label">
            <span>Curve length (px)</span><span id="lengthValue" class="value">300</span>
          </div>
          <input type="range" id="lengthSlider" min="150" max="500" value="300" />
        </label>
      </section>

      <section class="section">
        <div class="section-title">Display</div>
        <label class="check"><input type="checkbox" id="showCurve" checked /> Show base curve</label>
        <label class="check"><input type="checkbox" id="showJoints" checked /> Show joints</label>
        <label class="check"><input type="checkbox" id="showPivots" checked /> Show pivots</label>
        <label class="check"><input type="checkbox" id="showTrail" /> Show trail</label>
        <label class="check"><input type="checkbox" id="showLabels" checked /> Show labels</label>
        <label class="check"><input type="checkbox" id="showMfg" checked /> Laser-cut preview</label>
      </section>

      <section class="section">
        <div class="section-title">Anchor</div>
        <label class="check"><input type="checkbox" id="anchorMode" /> Anchor mode (click a pivot/joint)</label>
        <div class="button-row">
          <button id="btnClearAnchor">Clear anchor</button>
        </div>
        <div class="help">Anchored: <span id="anchorLabel">none</span></div>
      </section>

      <section class="section">
        <div class="section-title">Manufacturing / Export (SVG)</div>
        <div class="grid2">
          <label>Link width (mm)
            <input type="number" id="lc_linkWidth" value="12" step="0.1" />
          </label>
          <label>Hole Ø (mm)
            <input type="number" id="lc_holeDia" value="4" step="0.1" />
          </label>
          <label>Group tol (mm)
            <input type="number" id="lc_groupTol" value="0.1" step="0.05" />
          </label>
          <label>Spacing (mm)
            <input type="number" id="lc_spacing" value="6" step="0.5" />
          </label>
          <label>px → mm
            <input type="number" id="lc_px2mm" value="1" step="0.01" />
          </label>
          <label>Stroke (mm)
            <input type="number" id="lc_strokeW" value="0.1" step="0.05" />
          </label>
          <label>Kerf approx (mm)
            <input type="number" id="lc_kerf" value="0" step="0.05" />
          </label>
          <label>Per row
            <input type="number" id="lc_perRow" value="8" step="1" min="1" />
          </label>
        </div>
        <div class="button-row">
          <button id="btnExportSVG">Export SVG</button>
        </div>
        <div class="help">Export outlines (capsule) + two holes per link. Red stroke, no fill.</div>
      </section>

      <div class="button-row">
        <button id="resetBtn">Reset</button>
        <button id="randomBtn">Random</button>
      </div>
    </div>

    <!-- Top-right status -->
    <div class="info-panel">
      <div class="info-title">Status</div>
      <div class="info-item"><span>Curve:</span><span id="currentCurve">Arc</span></div>
      <div class="info-item"><span>Segments:</span><span id="totalSegments">4</span></div>
      <div class="info-item"><span>Pivots:</span><span id="pivotCount">-</span></div>
      <div class="info-item"><span>Arc length (px):</span><span id="currentLength">-</span></div>
      <div class="info-item">
        <span>Integrity:</span>
        <span id="integrity"><span class="dot dot-ok"></span><span id="integrityText">OK</span></span>
      </div>
      <div class="help">Wheel to zoom · Drag to pan · Free draw: drag on canvas · Anchor: toggle & click a node</div>
    </div>

    <!-- 确保脚本按正确顺序加载 -->
    <script>
      // 等待 p5.js 加载完成
      function waitForP5(callback) {
        if (window.p5) {
          callback();
        } else {
          setTimeout(() => waitForP5(callback), 100);
        }
      }
      
      waitForP5(() => {
        // 按顺序加载脚本
        const scripts = ['curve.js', 'mechanism.js', 'gui.js', 'main.js', 'exporter.js'];
        let loadedCount = 0;
        
        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        async function loadAllScripts() {
          try {
            for (const script of scripts) {
              await loadScript(script);
              console.log(`Loaded: ${script}`);
            }
            console.log('All scripts loaded successfully');
          } catch (error) {
            console.error('Failed to load script:', error);
          }
        }
        
        loadAllScripts();
      });
    </script>
  </body>
</html>